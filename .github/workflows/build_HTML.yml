on:
  push:
    branches:
      - main

name: Generate and deploy HTML

jobs:
  default_build:
    name: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Install Debian dependencies
        run: |
          sudo apt install python3-docutils python3-pygments

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      # Massage paragraph+literal blocks in to code blocks for syntax
      # highlighting
      - name: Build
        run: |
          git show origin/main:README.rst |
            sed 's,^\([^\.].*:\):$,\1\n\n.. code:: zsh,' |
            rst2html \
              --link-stylesheet \
              --rfc-references \
              --smart-quotes=yes \
              --source-url=https://github.com/JNRowe/river-configs \
              --strict \
              --stylesheet css/rhythm.css,css/monokai.css \
              --syntax-highlight=short \
              /dev/stdin index.html

      - name: Commit and push if it changed
        run: |
          git config user.name "Automated"
          git config user.email "actions@users.noreply.github.com"
          git add --all
          git commit \
            --message "Regenerated on $(git rev-parse --short $GITHUB_SHA)" \
            || exit 0
          git push
